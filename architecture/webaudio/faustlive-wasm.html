<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
            
        <!-- Origin Trial Token, feature = AudioWorklet, origin = https://faust.grame.fr, expires = 2018-01-27 -->
        <meta http-equiv="origin-trial" data-feature="AudioWorklet" data-expires="2018-03-03" content="ApDZ87+zpjI09+oIyEDTPDZtGN4bs1lh9n83f+4ssENINML3DxJbklOsd8Hu+M82TY4eIP/B2l7Iued7Y5I4hQAAAABUeyJvcmlnaW4iOiJodHRwczovL2ZhdXN0LmdyYW1lLmZyOjQ0MyIsImZlYXR1cmUiOiJBdWRpb1dvcmtsZXQiLCJleHBpcnkiOjE1MjAxMjA2MDB9">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700|Roboto:300,400" rel="stylesheet">

        <style type="text/css">
            * {
                font-family: 'Roboto', sans-serif;
                font-size: 14px;
                font-weight:normal;

            }
            body {
                margin-left: 10%;
                margin-right: 10%;
            }
            h1 {
                font-family: 'Open Sans', sans-serif;
                font-size: 30px;
                font-weight: lighter;
            }
            h2 {
                font-family: 'Open Sans', sans-serif;
                font-size: 24px;
            }
            h3 {
                font-family: 'Open Sans', sans-serif;
                font-size: 16px;
                font-weight: bold;
            }
            h4 {
                font-family: 'Open Sans', sans-serif;
                font-size: 14px;
                font-weight: bold;
            }

            .config {
                display:grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                grid-gap: 8px;
            }

            .config-element {
                border: none;
                background-color: #9FA8EB;
                padding: 10px;
            }
            .config-element p {
                font-style: italic;
            }
            .config-element ul {
                font-style: italic;
                list-style-type: none;
            }
            .config-element li {
                font-style: italic;
                list-style-type: none;
            }

            .line2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
        /* WEBKIT */
        text {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .faust-group-label {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 13px;
            fill: rgba(199,190,162,0.6);
        }

        .faust-tooltip-text {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 13px;
        }

        .faust-button-label {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 13px;
            fill: rgba(0,182,253,0.6);
        }

        .faust-tgroup-label {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 13px;
            fill: rgba(0,182,253,0.6);
        }

        .faust-label {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 13px;
            fill: rgba(0,182,253,0.6);
        }

        .faust-value-text {
            font-family: Arial, Verdana, Helvetica, sans;
            font-size: 11px;
            font-weight: bold;
            fill: rgb(82,79,79);
        }

        path {
            -webkit-user-select: none;
        }

        rect {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        }

        circle {
            -webkit-user-select: none;
        }

        text:hover {
            cursor: default;
        }

        path.faust-vbox {
            fill : white;
            stroke : black;
        }

        path.faust-rbutton-groove {
            fill : rgb(152,251,152);
            stroke : black;
        }

        path.faust-rbutton-handle {
            fill : grey;
            stroke : black;
        }

        rect.faust-hslider-meter {
            fill : url(#horizontalSliderMeterGradient);
        }

        rect.faust-hslider-groove {
            fill : rgba(28,126,192,0.65);
            stroke : rgba(0,182,253,0.9);
        }

        rect.faust-hslider-handle {
            fill : url(#horizontalSliderHandleGradient);
            stroke : black;
        }

        rect.faust-vslider-meter {
            fill : url(#verticalSliderMeterGradient);
        }

        rect.faust-vslider-groove {
            fill : rgba(28,126,192, 0.65);
            stroke : rgba(0,182,253,0.9);
        }

        rect.faust-vslider-handle {
            fill : url(#verticalSliderHandleGradient);
            stroke : black;
        }

        rect.faust-hbargraph-curtain {
            fill : rgb(20,20,20);
            stroke : black;
        }

        // hbargraph meters cannot be defined via CSS because their widths and
        // heights are dynamic

        rect.faust-hbargraph-meter {
            fill : url(#horizontalBarGraphMeterGradient);
            stroke : black;
        }

        rect.faust-vbargraph-curtain {
            fill : rgb(20,20,20);
            stroke : black;
        }

        rect.faust-vbargraph-meter {
            fill : url(#verticalBarGraphMeterGradient);
            stroke : black;
        }

        rect.faust-checkbox-box {
            fill : white;
            stroke : black;
        }

        path.faust-checkbox-check {
            fill : black;
            stroke : black;
        }

        rect.faust-nentry-box {
            fill : url(#numericalEntryUpGradient);
            stroke : black;
        }

        path.faust-nentry-operation {
            stroke : black;
        }

        rect.faust-button-box {
            fill : url(#buttonUpGradient);
            stroke : black;
        }

        rect.faust-tgroup-box {
            fill : url(#tabGroupUpGradient);
            stroke : black;
        }

        circle.faust-rbutton-groove {
            fill : url(#rotatingButtonHandleGradient);
        }

        circle.faust-rbutton-dot {
            fill : pink;
            stroke : black;
        }

        path.faust-rbutton-meter {
            fill : rgb(50,50,50);
        }

        path.faust-rbutton-mgroove {
            fill : url(#rotatingButtonMeterGradient);
        }

        // as all of the above rectangles could be implemented as paths, we duplicate the definitions for paths

        path.faust-hslider-groove {
            fill : red;
            stroke : black;
        }

        path.faust-hslider-handle {
            fill : url(#horizontalSliderHandleGradient);
            stroke : black;
        }

        path.faust-vslider-groove {
            fill : red;
            stroke : black;
        }

        path.faust-vslider-handle {
            fill : url(#verticalSliderHandleGradient);
            stroke : black;
        }

        path.faust-hbargraph-curtain {
            fill : rgb(0,255,255);
            stroke : black;
        }

        path.faust-hbargraph-meter {
            fill : grey;
            stroke : black;
        }

        path.faust-vbargraph-curtain {
            fill : rgb(0,255,255);
            stroke : black;
        }

        path.faust-vbargraph-meter {
            fill : grey;
            stroke : black;
        }

        path.faust-checkbox-box {
            fill : white;
            stroke : black;
        }

        path.faust-nentry-box {
            fill : url(#numericalEntryUpGradient);
            stroke : black;
        }

        path.faust-button-box {
            fill : #B0B0B0;
            stroke : black;
        }

        #filedrag{
            font-weight: bold;
            text-align: center;
            padding: 1em 0;
            margin: 1em 0;
            color: #8d97e8;
            border: 4px dashed #8d97e8;
            cursor: default;
            font-size : 20px;
        }

        #filedrag.hover{
            color: #FF7F00;
            border-color: #FF7F00;
            border-style: solid;
        }

        td { text-align: center; padding: 40px; }

        </style>

    </head>
    <body bgcolor= "#FFFFFF">
        <center> <H1 > Testing the embedded dynamic Faust compiler </H1> </center>
        
        <P> This page embeds the Faust compiler as a JavaScript library named libfaust.js (associated with the auxiliary WebAssembly library), including its WebAssembly generating backend, and compiled using <a href="http://kripken.github.io/emscripten-site/">Emscripten</a>.
            
        <P> You can compile Faust .dsp files or URL by just dropping them on the drop zone. A WebAudio node will be created and connected to audio inputs/outputs and controlled with the displayed HTML/SVG based GUI.
        <P>Settings (buffer size, polyphonic mode and voices, audio rendering model, ftz mode) can be changed dynamically and the DSP will be recompiled on the fly.
        <P>Clicking on the yellow cross on the top right allows to access to the GRAME online compiler, to generate  different targets (like for instance standalone applications, VST, Max/MSP plugins, iOS or JUCE ready projects...).
        <div class="config">

            <div class="config-element">
                <H3>Buffer size</H3>
                <form method="POST" name="menu">
                    <select id="selectedBuffer" name="selectedBuffer"
                        onChange="setBufferSize(this.form.selectedBuffer)">
                        <option value = 128> 128 </option>
                        <option value = 256> 256 </option>
                        <option value = 512> 512 </option>
                        <option selected value = 1024> 1024 </option>
                        <option value = 2048> 2048 </option>
                        <option value = 4096> 4096 </option>
                        <option value = 8192> 8192 </option>
                    </select>
                </form>
                <p>You can change the buffer size (from 256 to 8192 frames in ScripProcessor mode, it will be fixed at 128 frames in AudioWorklet mode).</p>
            </div>

            <div class="config-element">
                <H3>Polyphonic instrument</H3>
                <div class="line2">
                <form method="POST" name="menu">
                    <select id="selectedPoly" name="selectedPoly"
                        onChange="setPoly(this.form.selectedPoly)">
                        <option value = ON> ON </option>
                        <option selected value = OFF> OFF </option>
                    </select>
                </form>
                <form method="POST" name="menu">
                    <select id="polyVoices" name="polyVoices"
                        onChange="setPolyVoices(this.form.polyVoices)">
                        <option value = 4> 4 </option>
                        <option value = 8> 8 </option>
                        <option selected value = 16> 16 </option>
                        <option value = 32> 32 </option>
                        <option value = 64> 64 </option>
                        <option value = 128> 128 </option>
                    </select>
                </form>
                </div>
                <p>Assuming your DSP code is <a href="https://faust.grame.fr/news/2016/01/13/polyphonic-instruments.html ">polyphonic ready</a>, you can activate the polyphonic mode, adjust the number of available voices, and test it with a MIDI device or application (usable with Chrome which implements the <a href="https://webaudio.github.io/web-midi-api/">Web MIDI API</a>).
            </div>
            
            <div class="config-element">
                <H3>ScriptProcessor/AudioWorklet</H3>
                <form method="POST" name="menu" >
                    <select id="selectedRenderingMode" name="selectedRenderingMode"
                        onChange="setRenderingMode(this.form.selectedRenderingMode)">
                        <option selected value = ScriptProcessor> ScriptProcessor </option>
                        <option value = AudioWorklet> AudioWorklet </option>
                    </select>
                </form>
                <p>ScriptProcessor: audio rendering is done using the old ScriptProcessor model</p>
                <p>AudioWorklet: audio rendering is done using the new AudioWorklet model. This can only be tested with Chrome Canary for now, be sure to <a href="https://googlechromelabs.github.io/web-audio-samples/audio-worklet/">activate it</a><p>
            </div>

            <div class="config-element">
                <H3>Float denormals handling</H3>
                <form method="POST" name="menu">
                    <select id="selectedFTZ" name="selectedFTZ"
                        onChange="setFTZ(this.form.selectedFTZ)">
                        <option value = 0> 0 </option>
                        <option value = 1> 1 </option>
                        <option selected value = 2> 2 </option>
                    </select>
                </form>
                    <p>0: means no denormal handling</p>
                    <p>1: uses <B>fabs</B> and a <B>threshold</B> to detect denormal values (slower)<p>
                    <p>2: uses a <B>bitmask</B> to detect denormal values (faster)</p>
            </div>

        </div>

            <p> <input id="localstorage" type="checkbox" onclick="setLocalStorage(checked)"> <B>Save page and DSP control parameters state</B> </p>

            <div id="filedrag">
                Loading JavaScript/WebAssembly ressources...
            </div>

            <form id="upload" action="CompilerResponse" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="MAX_FILE_SIZE" name="MAX_FILE_SIZE" value="5000000" />
            </form>

            <script src="jsscripts.js"></script>
            <script src="libfaust-wasm.js"></script>
            <!-- <script src="binaryen.js"> </script> -->
            <script src="webaudio-wasm-wrapper.js"></script>
            <script type="text/javascript">

            'use strict';

            var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
            var isWasm = (typeof (WebAssembly) !== "undefined");
            var isPoly = false;

            if (!isWasm) {
                alert("WebAssembly is not supported in this browser, the page will not work !")
            }
            
            function workletAvailable()
            {
                if (typeof (OfflineAudioContext) === "undefined") return false;
                var context = new OfflineAudioContext(1, 1, 44100);
                return context.audioWorklet && typeof context.audioWorklet.addModule === 'function';
            }

            var audio_context = (isWebKitAudio) ? new webkitAudioContext() : new AudioContext();
            var buffer_size = 1024;
            var audio_input = null;
            var factory = null;
            var DSP = null;
            var dsp_code = null;
            var faust_svg = null;
            var poly_flag = "OFF";
            var ftz_flag = "2";
            var poly_nvoices = 16;
            var rendering_mode = "ScriptProcessor";
            var output_handler = null;
            
            /*
            // compute libraries URL relative to current page
            var wurl =  window.location.href;
            var qm = wurl.indexOf('?');
            if (qm > 0) {
                wurl = wurl.substr(0, qm);  // remove options from the URL
            }
            var libraries_url = wurl.substr(0, wurl.lastIndexOf('/')) + "/libraries/";
            console.log("libraries_url :", libraries_url);
            */

            var libraries_url = "http://127.0.0.1:8000/libraries/";
            //var libraries_url = "https://faust.grame.fr/libraries/";

            function setBufferSize(bs_item)
            {
                buffer_size = parseInt(bs_item.options[bs_item.selectedIndex].value);
                if (buffer_size === 128 && rendering_mode === "ScriptProcessor") {
                    console.log("buffer_size cannot be set to 128 in ScriptProcessor mode !");
                    buffer_size = 256;
                    restoreMenu("selectedBuffer", buffer_size);
                }
                compileDSP();
            }

            function setPoly(poly_item)
            {
                poly_flag = poly_item.options[poly_item.selectedIndex].value;
                compileDSP();
            }

            function setPolyVoices(voices_item)
            {
                poly_nvoices = parseInt(voices_item.options[voices_item.selectedIndex].value);
                compileDSP();
            }
            
            function setRenderingMode(rendering_item)
            {
                rendering_mode = rendering_item.options[rendering_item.selectedIndex].value;
                if (rendering_mode === "AudioWorklet") {
                    buffer_size = 128;
                    restoreMenu("selectedBuffer", buffer_size);
                    document.getElementById("selectedBuffer").disabled = true;
                } else {
                    buffer_size = 1024;
                    restoreMenu("selectedBuffer", buffer_size);
                    document.getElementById("selectedBuffer").disabled = false;
                }
                compileDSP();
            }

            function setFTZ(ftz_item)
            {
                ftz_flag = ftz_item.options[ftz_item.selectedIndex].value;
                compileDSP();
            }

            // MIDI input handling
            function keyOn(channel, pitch, velocity)
            {
                if (DSP && isPoly) {
                    DSP.keyOn(channel, pitch, velocity);
                }
            }

            function keyOff(channel, pitch, velocity)
            {
                if (DSP && isPoly) {
                    DSP.keyOff(channel, pitch, velocity);
                }
            }

            function pitchWheel(channel, bend)
            {
                if (DSP) {
                    DSP.pitchWheel(channel, bend);
                }
            }

            function ctrlChange(channel, ctrl, value)
            {
                if (DSP) {
                    DSP.ctrlChange(channel, ctrl, value);
                }
            }

            function midiMessageReceived(ev)
            {
                var cmd = ev.data[0] >> 4;
                var channel = ev.data[0] & 0xf;
                var data1 = ev.data[1];
                var data2 = ev.data[2];

                if (channel === 9) {
                    return;
                } else if (cmd === 8 || ((cmd === 9) && (data2 === 0))) {
                    keyOff(channel, data1, data2);
                } else if (cmd === 9) {
                    keyOn(channel, data1, data2);
                } else if (cmd === 11) {
                    ctrlChange(channel, data1, data2);
                } else if (cmd === 14) {
                    pitchWheel(channel, ((data2 * 128.0 + data1)-8192)/8192.0);
                }
                
                /*
                // Direct message
                if (DSP && isPoly) {
                    DSP.midiMessage(ev.data);
                }
                */
            }

            function onerrorcallback(error)
            {
                console.log(error);
            }
            
            function onsuccesscallbackStandard(access)
            {
                access.onstatechange = function(e) {
                    if (e.port.type === "input") {
                        if (e.port.state === "connected") {
                            console.log(e.port.name + " is connected");
                            e.port.onmidimessage = midiMessageReceived;
                        } else if (e.port.state  === "disconnected") {
                            console.log(e.port.name + " is disconnected");
                            e.port.onmidimessage = null;
                        }
                    }
                }
                
                for (var input of access.inputs.values()) {
                    input.onmidimessage = midiMessageReceived;
                    console.log(input.name + " is connected");
                }
            }
            
            function activateMIDIInput()
            {
                console.log("activateMIDIInput");
                if (typeof(navigator.requestMIDIAccess) !== "undefined") {
                    navigator.requestMIDIAccess().then(onsuccesscallbackStandard, onerrorcallback);
                } else {
                    alert("MIDI input cannot be activated, either your browser still does't have it, or you need to explicitly activate it.");
                }
            }

            // Audio input handling
            function activateAudioInput()
            {
                console.log("activateAudioInput");
                if (!navigator.getUserMedia) {
                    navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                }

                if (navigator.getUserMedia) {
                    navigator.getUserMedia({audio: { echoCancellation: false }}, getDevice, function(e) {
                                           alert('Error getting audio input');
                                           console.log(e);
                                           audio_input = null;
                                           });
                } else {
                    alert('Audio input API not available');
                }
            }

            function getDevice(device)
            {
                // Create an AudioNode from the stream.
                audio_input = audio_context.createMediaStreamSource(device);

                // Connect it to the destination.
                audio_input.connect(DSP);
            }

            function setLocalStorage(state)
            {
                console.log(state);
                setStorageItemValue('FaustLibTester', 'FaustLocalStorage', ((state) ? "on" : "off"));
            }

            // Save/Load functions using local storage
            function restoreMenu(id, value)
            {
                for (var i = 0; i < document.getElementById(id).length; i++) {
                    // Weak comparison here
                    if (document.getElementById(id).options[i].value == value) {
                        document.getElementById(id).selectedIndex = i;
                        break;
                    }
                }
            }
            
            //set item from local storage 'item_key' key
            function getStorageItemValue(item_key, key)
            {
                if (localStorage.getItem(item_key)) {
                    var item_value = JSON.parse(localStorage.getItem(item_key));
                    var item_index = item_value.findIndex((obj => obj[0] === key));
                    return (item_index >= 0) ? item_value[item_index][1]: null;
                } else {
                    return null;
                }
            }
            
            //get [key, value] in local storage item_key key
            function setStorageItemValue(item_key, key, value)
            {
                var item_value;
                if (localStorage.getItem(item_key)) {
                    item_value = JSON.parse(localStorage.getItem(item_key));
                } else {
                    item_value = [];
                }
                
                // Possibly update an existing 'key'
                var item_index = item_value.findIndex((obj => obj[0] === key));
                if (item_index >= 0) {
                    item_value[item_index][1] = value;
                    // Otherwise push a new [key, value]
                } else {
                    item_value.push([key, value]);
                }
                
                localStorage.setItem(item_key, JSON.stringify(item_value));
            }
            
            function saveDSPState()
            {
                var params = DSP.getParams();
                for (var i = 0; i < params.length; i++) {
                    setStorageItemValue('DSP', params[i], DSP.getParamValue(params[i]));
                }
            }
            
            function loadDSPState()
            {
                var params = DSP.getParams();
                for (var i = 0; i < params.length; i++) {
                    var value = getStorageItemValue('DSP', params[i]);
                    if (value) {
                        // Restore DSP state
                        DSP.setParamValue(params[i], Number(value));
                        // Restore GUI state
                        output_handler(params[i], Number(value));
                    }
                }
            }
  
            function savePageState()
            {
                if (getStorageItemValue('FaustLibTester', 'FaustLocalStorage') === "on") {
                    setStorageItemValue('FaustLibTester', 'buffer_size', buffer_size);
                    setStorageItemValue('FaustLibTester', 'poly_flag', poly_flag);
                    setStorageItemValue('FaustLibTester', 'ftz_flag', ftz_flag);
                    setStorageItemValue('FaustLibTester', 'poly_nvoices', poly_nvoices);
                    setStorageItemValue('FaustLibTester', 'rendering_mode', rendering_mode);
                }
            }
       
            function loadPageState()
            {
                if (getStorageItemValue('FaustLibTester', 'FaustLocalStorage') === "on") {
                    buffer_size = (getStorageItemValue('FaustLibTester', 'buffer_size') ? getStorageItemValue('FaustLibTester', 'buffer_size') : 256);
                    poly_flag = (getStorageItemValue('FaustLibTester', 'poly_flag') ? getStorageItemValue('FaustLibTester', 'poly_flag') : "OFF");
                    poly_nvoices = (getStorageItemValue('FaustLibTester', 'poly_nvoices') ? getStorageItemValue('FaustLibTester', 'poly_nvoices') : 16);
                    ftz_flag = (getStorageItemValue('FaustLibTester', 'ftz_flag') ? getStorageItemValue('FaustLibTester', 'ftz_flag') : 2);
                    rendering_mode = (getStorageItemValue('FaustLibTester', 'rendering_mode') ? getStorageItemValue('FaustLibTester', 'rendering_mode') : "ScriptProcessor");
                    
                    // Restore menus
                    restoreMenu("selectedBuffer", buffer_size);
                    restoreMenu("selectedPoly", poly_flag);
                    restoreMenu("polyVoices", poly_nvoices);
                    restoreMenu("selectedFTZ", ftz_flag);
                    restoreMenu("selectedRenderingMode", rendering_mode);
                    
                    if (rendering_mode === "AudioWorklet") {
                        document.getElementById("selectedBuffer").disabled = true;
                    }
                }
            }

            function fileDragHover(e)
            {
                e.stopPropagation();
                e.preventDefault();
                e.target.className = (e.type === "dragover" ? "hover" : "");
            }

            function fileSelectHandler(e)
            {
                fileDragHover(e);
                var files = e.target.files || e.dataTransfer.files;
                f = files[0];
                uploadFile(f);
            }

            function uploadOn(e, callback)
            {
                if (!isWasm) {
                    alert("WebAssembly is not supported in this browser !")
                    return;
                }

                // CASE 1 : THE DROPPED OBJECT IS A URL TO SOME FAUST CODE
                if (e.dataTransfer.getData('URL') && e.dataTransfer.getData('URL').split(':').shift() != "file") {
                    var url = e.dataTransfer.getData('URL');
                    var filename = url.toString().split( '/' ).pop();
                    filename = filename.toString().split('.').shift();
                    var xmlhttp = new XMLHttpRequest();

                    xmlhttp.onreadystatechange = function() {
                        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                            dsp_code = xmlhttp.responseText;
                            callback();
                        }
                    }

                    try {
                        xmlhttp.open("GET", url, false);
                        // Avoid error "mal formÃ©" on firefox
                        xmlhttp.overrideMimeType('text/html');
                        xmlhttp.send();
                    } catch (err) {
                        alert(err);
                    }
                    
                } else if (e.dataTransfer.getData('URL').split(':').shift() != "file") {
                    dsp_code = e.dataTransfer.getData('text');

                    // CASE 2 : THE DROPPED OBJECT IS SOME FAUST CODE
                    if (dsp_code) {
                        callback();
                    }
                    // CASE 3 : THE DROPPED OBJECT IS A FILE CONTAINING SOME FAUST CODE
                    else {
                        var files = e.target.files || e.dataTransfer.files;
                        var file = files[0];

                        if (location.host.indexOf("sitepointstatic") >= 0) return;

                        var request = new XMLHttpRequest();
                        if (request.upload) {

                            var reader = new FileReader();
                            var ext = file.name.toString().split('.').pop();
                            var filename = file.name.toString().split('.').shift();
                            var type;

                            if (ext === "dsp") {
                                type = "dsp";
                                reader.readAsText(file);
                            } else if (ext === "json") {
                                type = "json";
                                reader.readAsText(file);
                            }

                            reader.onloadend = function(e) {
                                dsp_code = reader.result;
                                callback();
                            };
                        }
                    }
                }
                // CASE 4 : ANY OTHER STRANGE THING
                else {
                    window.alert("This object is not Faust code...");
                }
            }
            
            function checkPolyphonicDSP(json)
            {
                if (!((json.indexOf("/freq") !== -1)
                    && (json.indexOf("/gain") !== -1)
                    && (json.indexOf("/gate") !== -1))) {
                    alert("Faust DSP code is not Polyphonic, it will probably not work correctly in this mode...")
                }
            }
            
            function deleteDSP()
            {
                if (DSP) {
                    if (audio_input) {
                        audio_input.disconnect(DSP);
                    }
                    DSP.disconnect(audio_context.destination);
                    if (isPoly) {
                        faust.deletePolyDSPInstance(DSP);
                    } else {
                        faust.deleteDSPInstance(DSP);
                    }
                    _f4u$t.hard_delete(faust_svg);
                    
                    DSP = null;
                    faust_svg = null;
                }
            }
            
            function activateMonoDSP(dsp)
            {
                if (!dsp) {
                    alert(faust.getErrorMessage());
                    return;
                }
                
                DSP = dsp;
                if (DSP.getNumInputs() > 0) {
                    activateAudioInput();
                } else {
                    audio_input = null;
                }
                
                // Setup UI
                faust_svg = $('<div />');
                $('body').append(faust_svg);
                output_handler = _f4u$t.main(DSP.getJSON(), $(faust_svg), function(path, val) { DSP.setParamValue(path, val); });
                DSP.setOutputParamHandler(output_handler);
                console.log(DSP.getNumInputs());
                console.log(DSP.getNumOutputs());
                //DSP.metadata({ declare: function(key, value) { console.log("key = " + key + " value = " + value); }});
                DSP.connect(audio_context.destination);
                
                loadDSPState();
            }
            
            function activatePolyDSP(dsp)
            {
                if (!dsp) {
                    alert(faust.getErrorMessage());
                    return;
                }
                checkPolyphonicDSP(dsp.getJSON());
                DSP = dsp;
                
                if (DSP.getNumInputs() > 0) {
                    activateAudioInput();
                } else {
                    audio_input = null;
                }
                
                // Setup UI
                faust_svg = $('<div />');
                $('body').append(faust_svg);
                output_handler = _f4u$t.main(DSP.getJSON(), $(faust_svg), function(path, val) { DSP.setParamValue(path, val); });
                DSP.setOutputParamHandler(output_handler);
                console.log(DSP.getNumInputs());
                console.log(DSP.getNumOutputs());
                //DSP.metadata({ declare: function(key, value) { console.log("key = " + key + " value = " + value); }});
                DSP.connect(audio_context.destination);
                
                loadDSPState();
            }
            
            function compileMonoDSP(factory)
            {
                if (rendering_mode === "ScriptProcessor") {
                    console.log("ScriptProcessor createDSPInstance");
                    faust.createDSPInstance(factory, audio_context, buffer_size, activateMonoDSP);
                } else {
                    console.log("Worklet createDSPWorkletInstance");
                    faust.createDSPWorkletInstance(factory, audio_context, activateMonoDSP);
                }
            }
            
            function compilePolyDSP(factory)
            {
            	if (rendering_mode === "ScriptProcessor") {
                    console.log("ScriptProcessor createPolyDSPInstance");
                	faust.createPolyDSPInstance(factory, audio_context, buffer_size, poly_nvoices, activatePolyDSP);
                } else {
                    console.log("Worklet createPolyDSPWorkletInstance");
                	faust.createPolyDSPWorkletInstance(factory, audio_context, poly_nvoices, activatePolyDSP);
                }
            }

            function compileDSP()
            {
                if (!dsp_code) {
                    return;
                }

                deleteDSP();

                // Prepare argv list
                var argv = [];
                argv.push("-ftz");
                argv.push(ftz_flag);
                argv.push("-I");
                argv.push(libraries_url);

                console.log(argv);

                if (poly_flag === "ON") {

                    isPoly = true;
                    console.log("Poly DSP");

                    // Create a poly DSP factory from the dsp code
                    faust.createPolyDSPFactory(dsp_code,
                                               argv,
                                               function (factory) {
                                                    if (!factory) {
                                                        alert(faust.getErrorMessage());
                                                        return;
                                                    }
                                                    compilePolyDSP(factory);
                                               });
                } else {

                    isPoly = false;
                    console.log("Mono DSP");

                    // Create a mono DSP factory from the dsp code
                    faust.createDSPFactory(dsp_code,
                                           argv,
                                           function (factory) {
                                                if (!factory) {
                                                    alert(faust.getErrorMessage());
                                                    return;
                                                }
                                                compileMonoDSP(factory);
                                           });
                }
            }

            function uploadFile(e)
            {
                fileDragHover(e);
                uploadOn(e, compileDSP);
            }

            function initPage()
            {
                // No polling from the server needed, so use an empty loop
                _f4u$t.main_loop = function() {}
                
                // Restore 'save' checkbox state
                document.getElementById("localstorage").checked = (getStorageItemValue('FaustLibTester', 'FaustLocalStorage') === "on");

                // Load page state
                loadPageState();
            }
            
            function init()
            {
                // Check AudioWorklet support
                if (!workletAvailable()) {
                    document.getElementById("selectedRenderingMode").disabled = true;
                    alert("AudioWorklet is not supported, ScriptProcessor model only will be available");
                }
                
                activateMIDIInput();
                
                var filedrag1 = document.getElementById("filedrag");
                filedrag1.addEventListener("dragover", fileDragHover, false);
                filedrag1.addEventListener("dragleave", fileDragHover, false);
                filedrag1.addEventListener("drop", uploadFile, false);
                filedrag1.textContent = "Drop a Faust .dsp file or URL here (compiled using libfaust version " + faust.getLibFaustVersion() + ")";
            }

            // Init page
            initPage();

            // Timer to save page and DSP state to local storage
            setInterval(function() { savePageState(); if (DSP) { saveDSPState(); }}, 1000);
            
            // 'faust_module' global is defined in webaudio-wasm-wrapper.js file, 'onRuntimeInitialized' will be called when code is ready
            // (see https://kripken.github.io/emscripten-site/docs/getting_started/FAQ.html)
            
            faust_module['onRuntimeInitialized'] = init;
            
            // To activate audio on iOS
			window.addEventListener('touchstart', function() {
                        
                        // create empty buffer
                        var buffer = audio_context.createBuffer(1, 1, 22050);
                        var source = audio_context.createBufferSource();
                        source.buffer = buffer;
                        
                        // connect to output (your speakers)
                        source.connect(audio_context.destination);
                        
                        // play the file
                        source.start();
                        
                        }, false);

            </script>

            <!-- Add FaustWeb Compilation service to Page -->
            <div id="export" style="color:white; position: absolute; width:400px; padding:2px 2px 2px 2px; background-color:hsla(59, 99%, 50%, 0.92); visibility:hidden; ">

                <div id="centerDiv" style="position:relative; margin-right:auto; margin-left:auto; text-align:center;">
                    <input id="exportUrl" style="color:black; border:0px; text-align:center; font-size:11px; background-color:#00000000; outline: 0px solid transparent; position:relative; margin-left:auto; margin-right:auto; text-align:center;" contenteditable="true" value="https://faustservice.grame.fr" onkeyup="onEnterKey()"/>
                    </br>
                    </br>
                    </br>
                    <div id="refreshButton" style="position:absolute; left:10px; top:46px;">
                        <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                            width="50.000000pt" height="50.000000pt" viewBox="0 0 50.000000 50.000000"
                            preserveAspectRatio="xMidYMid meet">
                            <g transform="translate(0.000000,50.000000) scale(0.100000,-0.100000)"
                                fill="#000000" stroke="none">
                                <path d="M186 309 c-37 -29 -37 -89 0 -118 28 -22 69 -27 93 -12 23 15 3 30
                                -33 24 -29 -4 -37 -1 -51 21 -16 24 -16 28 -1 51 18 27 63 34 84 13 17 -17 15
                                -31 -3 -24 -20 7 -19 1 6 -28 l22 -25 18 24 c20 25 25 40 9 30 -5 -3 -16 7
                                -24 23 -25 47 -75 56 -120 21z"/>
                            </g>
                        </svg>
                    </div>
                    <select id="Platform" style="width:250px;" onChange="changeArchs()">
                    </select>
                    </br>
                    <select id="Architecture" style="width:250px;">
                    </select>
                    </br>
                    </br>
                    <input id="exportButton" type="button" value="Export" onclick="getFaustSource()" style="border: 2px solid black; border-radius:4px; color:black; font-size:16px;  background-color:transparent;"/>
                    </br>
                    </br>
                    <div id="qrDiv">

                        <div id="loader" style="visibility:hidden;">
                            <svg width='50px' height='50px' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-ring">
                                <rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect>
                                <defs>
                                    <filter id="uil-ring-shadow" x="-100%" y="-100%" width="300%" height="300%">
                                        <feOffset result="offOut" in="SourceGraphic" dx="0" dy="0"></feOffset>
                                        <feGaussianBlur result="blurOut" in="offOut" stdDeviation="0"></feGaussianBlur>
                                        <feBlend in="SourceGraphic" in2="blurOut" mode="normal"></feBlend>
                                    </filter>
                                </defs>
                                <path d="M10,50c0,0,0,0.5,0.1,1.4c0,0.5,0.1,1,0.2,1.7c0,0.3,0.1,0.7,0.1,1.1c0.1,0.4,0.1,0.8,0.2,1.2c0.2,0.8,0.3,1.8,0.5,2.8 c0.3,1,0.6,2.1,0.9,3.2c0.3,1.1,0.9,2.3,1.4,3.5c0.5,1.2,1.2,2.4,1.8,3.7c0.3,0.6,0.8,1.2,1.2,1.9c0.4,0.6,0.8,1.3,1.3,1.9 c1,1.2,1.9,2.6,3.1,3.7c2.2,2.5,5,4.7,7.9,6.7c3,2,6.5,3.4,10.1,4.6c3.6,1.1,7.5,1.5,11.2,1.6c4-0.1,7.7-0.6,11.3-1.6 c3.6-1.2,7-2.6,10-4.6c3-2,5.8-4.2,7.9-6.7c1.2-1.2,2.1-2.5,3.1-3.7c0.5-0.6,0.9-1.3,1.3-1.9c0.4-0.6,0.8-1.3,1.2-1.9 c0.6-1.3,1.3-2.5,1.8-3.7c0.5-1.2,1-2.4,1.4-3.5c0.3-1.1,0.6-2.2,0.9-3.2c0.2-1,0.4-1.9,0.5-2.8c0.1-0.4,0.1-0.8,0.2-1.2 c0-0.4,0.1-0.7,0.1-1.1c0.1-0.7,0.1-1.2,0.2-1.7C90,50.5,90,50,90,50s0,0.5,0,1.4c0,0.5,0,1,0,1.7c0,0.3,0,0.7,0,1.1 c0,0.4-0.1,0.8-0.1,1.2c-0.1,0.9-0.2,1.8-0.4,2.8c-0.2,1-0.5,2.1-0.7,3.3c-0.3,1.2-0.8,2.4-1.2,3.7c-0.2,0.7-0.5,1.3-0.8,1.9 c-0.3,0.7-0.6,1.3-0.9,2c-0.3,0.7-0.7,1.3-1.1,2c-0.4,0.7-0.7,1.4-1.2,2c-1,1.3-1.9,2.7-3.1,4c-2.2,2.7-5,5-8.1,7.1 c-0.8,0.5-1.6,1-2.4,1.5c-0.8,0.5-1.7,0.9-2.6,1.3L66,87.7l-1.4,0.5c-0.9,0.3-1.8,0.7-2.8,1c-3.8,1.1-7.9,1.7-11.8,1.8L47,90.8 c-1,0-2-0.2-3-0.3l-1.5-0.2l-0.7-0.1L41.1,90c-1-0.3-1.9-0.5-2.9-0.7c-0.9-0.3-1.9-0.7-2.8-1L34,87.7l-1.3-0.6 c-0.9-0.4-1.8-0.8-2.6-1.3c-0.8-0.5-1.6-1-2.4-1.5c-3.1-2.1-5.9-4.5-8.1-7.1c-1.2-1.2-2.1-2.7-3.1-4c-0.5-0.6-0.8-1.4-1.2-2 c-0.4-0.7-0.8-1.3-1.1-2c-0.3-0.7-0.6-1.3-0.9-2c-0.3-0.7-0.6-1.3-0.8-1.9c-0.4-1.3-0.9-2.5-1.2-3.7c-0.3-1.2-0.5-2.3-0.7-3.3 c-0.2-1-0.3-2-0.4-2.8c-0.1-0.4-0.1-0.8-0.1-1.2c0-0.4,0-0.7,0-1.1c0-0.7,0-1.2,0-1.7C10,50.5,10,50,10,50z" fill="white" filter="url(#uil-ring-shadow)">
                                    <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" repeatCount="indefinite" dur="1.5s"></animateTransform>
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>
                </br>
            </div>

            <div id="plusImg" style="position: absolute; z-index=4; visibility:visible;">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                    width="50.000000pt" height="51.000000pt" viewBox="0 0 50.000000 51.000000"
                    preserveAspectRatio="xMidYMid meet">
                    <g transform="translate(0.000000,51.000000) scale(0.100000,-0.100000)"
                        fill="#f9be0d" stroke="none">
                        <path d="M205 481 c-89 -22 -153 -85 -175 -174 -25 -96 28 -204 122 -251 84
                        -42 166 -31 239 33 126 107 95 315 -56 376 -43 18 -95 24 -130 16z m153 -54
                        c58 -38 97 -120 89 -188 -7 -60 -36 -109 -84 -146 -51 -39 -154 -45 -212 -12
                        -116 65 -137 235 -39 326 64 60 173 69 246 20z"/>
                        <path d="M190 373 l0 -53 -55 0 -55 0 0 -60 0 -60 55 0 55 0 0 -55 0 -55 60 0
                        60 0 0 55 0 55 53 0 53 0 0 60 -1 60 -52 0 -52 0 -3 52 -3 51 -58 1 -57 1 0
                        -52z m100 -18 l0 -55 50 0 50 0 0 -40 0 -40 -50 0 -50 0 0 -55 0 -55 -40 0
                        -40 0 0 55 0 55 -55 0 -55 0 0 40 0 40 55 0 55 0 0 55 0 55 40 0 40 0 0 -55z"/>
                    </g>
                </svg>
            </div>
            <div id="moinsImg" style="position: absolute; z-index=4; visibility:hidden;">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                    width="50.000000pt" height="51.000000pt" viewBox="0 0 50.000000 51.000000"
                    preserveAspectRatio="xMidYMid meet" >
                    <g transform="translate(0.000000,51.000000) scale(0.100000,-0.100000)"
                        fill="#f9be0d" stroke="none">
                        <path d="M187 466 c-92 -34 -157 -123 -157 -217 0 -100 79 -196 180 -218 143
                        -31 270 72 270 219 0 66 -16 107 -59 153 -57 62 -161 90 -234 63z m162 -36
                        c78 -39 118 -115 107 -204 -19 -167 -227 -236 -342 -114 -46 48 -57 76 -58
                        139 -1 74 39 142 103 176 56 29 136 31 190 3z"/>
                        <path d="M90 250 l0 -60 170 0 170 0 0 60 0 60 -170 0 -170 0 0 -60z m320 0
                        l0 -40 -150 0 -150 0 0 40 0 40 150 0 150 0 0 -40z"/>
                    </g>
                </svg>
            </div>

            <script src="ExportLib.js"></script>
            <script src="qrcode.js"></script>

            <script>

            function onEnterKey(e)
            {
                if (!e) { var e = window.event; }

                if (e.keyCode === 13) {
                    e.preventDefault();
                    updateFWTargets();
                }
            }

            function openExport()
            {
                document.getElementById("plusImg").style.visibility = "hidden";
                document.getElementById("moinsImg").style.visibility = "visible";
                document.getElementById("export").style.visibility = "visible";
            }

            function closeExport(event)
            {
                if (!event) { event = window.event; }

                var target = event.target
                while (target && target != document.getElementById("export") && target != document.getElementById("plusImg"))
                target= target.parentNode;

                if (!target) {
                    document.getElementById("plusImg").style.visibility = "visible";
                    document.getElementById("moinsImg").style.visibility = "hidden";
                    document.getElementById("export").style.visibility = "hidden";
                }
            }

            function updateQrCode(sha)
            {
                // Empty Div before adding new qrcode
                var toEmpty = document.getElementById("qrDiv");

                document.getElementById("loader").style.visibility = "hidden";

                for (var i = toEmpty.children.length-1; i >= 0; i--) {
                    if (toEmpty.children[i].id != "loader") {
                        toEmpty.removeChild(toEmpty.children[i]);
                    }
                }

                var plateform = document.getElementById("Platform").options[document.getElementById("Platform").selectedIndex].value;
                var architecture = document.getElementById("Architecture").options[document.getElementById("Architecture").selectedIndex].value;
                var output = "binary.zip";

                if (plateform === "android") {
                    output = "binary.apk";
                }

                var link = document.createElement('a');
                link.href = document.getElementById("exportUrl").value + "/" + sha + "/" + plateform + "/" + architecture + "/" + output;

                // 	Delete existing content if existing
                var qrcodeSpan = document.getElementById('qrcodeDiv');
                if (qrcodeSpan) {
                    qrcodeSpan.parentNode.removeChild(qrcodeSpan);
                }

                var myWhiteDiv = getQrCode(document.getElementById("exportUrl").value, sha, plateform, architecture, output, 130);

                document.getElementById("qrDiv").appendChild(link);
                link.appendChild(myWhiteDiv);
            }

            function cancelLoader()
            {
                document.getElementById("loader").style.visibility = "hidden";
            }

            function getFaustSource()
            {
                document.getElementById("loader").style.visibility = "visible";

                if (!dsp_code) {

                    var url = window.location.href.split('.html').shift() + ".dsp";
                    var filename = url.toString().split( '/' ).pop();
                    filename = filename.toString().split('.').shift();
                    var xmlhttp = new XMLHttpRequest();

                    xmlhttp.onreadystatechange = function() {
                        if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                            var dsp_code = xmlhttp.responseText;
                            getSHAKey(document.getElementById("exportUrl").value, filename, dsp_code, updateQrCode, cancelLoader);
                        }
                    }
                    xmlhttp.open("GET", url, false );
                    xmlhttp.send();
                } else {
                    // Global 'dsp_code', so use it
                    getSHAKey(document.getElementById("exportUrl").value, "FaustDSP", dsp_code, updateQrCode, cancelLoader);
                }
            }

            function cleanComboBox(id)
            {
                while (document.getElementById(id).childNodes.length>0) {
                    document.getElementById(id).removeChild(document.getElementById(id).childNodes[0]);
                }
            }

            function changeArchs()
            {
                // CLEAN COMBOBOX BEFORE ADDING NEW OPTIONS
                cleanComboBox("Architecture");

                var plat = document.getElementById("Platform").options[document.getElementById("Platform").selectedIndex].value;
                var archs = getArchitectures(window.json, plat);

                for (var j = 0; j < archs.length; j++) {
                    var a = document.createElement('option');
                    a.text=archs[j];
                    document.getElementById("Architecture").options.add(a);
                }
            }

            function updateFWTargets()
            {
                // CLEAN COMBOBOX BEFORE ADDING NEW OPTIONS
                cleanComboBox("Platform");
                cleanComboBox("Architecture");

                getTargets(document.getElementById("exportUrl").value, function(json) {
                    window.json = json;
                    var plats = getPlatforms(json);

                    for (var i = 0; i < plats.length; i++) {
                        var o = document.createElement('option');
                        o.text = plats[i];
                        document.getElementById("Platform").options.add(o);
                    }

                    changeArchs();
                }, function(){});
            }

            function changeOrientation(orientation)
            {
                if (orientation === "topright") {

                    document.getElementById("plusImg").style.top = "0px";
                    document.getElementById("plusImg").style.right = "0px";
                    document.getElementById("moinsImg").style.top = "0px";
                    document.getElementById("moinsImg").style.right = "0px";

                    document.getElementById("export").style.top = "0%";
                    document.getElementById("export").style.right = "0%";
                    /*document.getElementById("export").style.boxShadow ="0px 2px 2px 0px white";
                    document.getElementById("export").style.borderRadius ="0px 0px 0px 25px";
                    document.getElementById("export").style.borderBottom = "3px solid white";
                    document.getElementById("export").style.borderLeft ="3px solid white";*/

                } else if (orientation === "bottomright") {

                    document.getElementById("plusImg").style.bottom = "0px";
                    document.getElementById("plusImg").style.right = "0px";
                    document.getElementById("moinsImg").style.bottom = "0px";
                    document.getElementById("moinsImg").style.right = "0px";

                    document.getElementById("export").style.bottom = "0%";
                    document.getElementById("export").style.right = "0%";
                    document.getElementById("export").style.boxShadow ="2px 2px 0px px white";
                    document.getElementById("export").style.borderRadius ="25px 0px 0px 0px";
                    document.getElementById("export").style.borderTop = "3px solid white";
                    document.getElementById("export").style.borderLeft ="3px solid white";

                } else if (orientation === "bottomleft") {

                    document.getElementById("plusImg").style.bottom = "0px";
                    document.getElementById("plusImg").style.left = "0px";
                    document.getElementById("moinsImg").style.bottom = "0px";
                    document.getElementById("moinsImg").style.left = "0px";

                    document.getElementById("export").style.bottom = "0%";
                    document.getElementById("export").style.left = "0%";
                    document.getElementById("export").style.boxShadow ="2px 0px 2px 0px white";
                    document.getElementById("export").style.borderRadius ="0px 25px 0px 0px";
                    document.getElementById("export").style.borderTop = "3px solid white";
                    document.getElementById("export").style.borderRight ="3px solid white";

                } else if (orientation === "topleft") {

                    document.getElementById("plusImg").style.top = "0px";
                    document.getElementById("plusImg").style.left = "0px";
                    document.getElementById("moinsImg").style.top = "0px";
                    document.getElementById("moinsImg").style.left = "0px";

                    document.getElementById("export").style.top = "0%";
                    document.getElementById("export").style.left = "0%";
                    document.getElementById("export").style.boxShadow ="0px 0px 2px 2px white";
                    document.getElementById("export").style.borderRadius ="0px 0px 25px 0px";
                    document.getElementById("export").style.borderBottom = "3px solid white";
                    document.getElementById("export").style.borderRight ="3px solid white";

                }
            }

            changeOrientation("topright");
            //changeOrientation("bottomright");
            //changeOrientation("bottomleft");
            //changeOrientation("topleft");

            updateFWTargets();

            document.getElementById("refreshButton").onclick=updateFWTargets;
            document.getElementById("plusImg").onclick=openExport;
            document.getElementById("moinsImg").onclick=closeExport;
            document.body.addEventListener("click", closeExport, false);
            </script>

            <!-- End FaustWeb Compilation Service -->

            </body>
</html>
